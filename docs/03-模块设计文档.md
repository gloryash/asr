# 模块设计文档

> 文档版本：v2.0
> 更新日期：2026-01-29
> 文档状态：已审核
> 技术栈：React 19 + TypeScript + Vite

---

## 1. 文档概述

本文档详细描述语音对话模块的各个子模块设计，包括每个模块的：
- 职责边界
- 输入/输出规范
- 接口定义
- 依赖关系

---

## 2. 模块总览

```
┌─────────────────────────────────────────────────────────┐
│                   VoiceChatEngine                       │
│                    (对话引擎)                            │
├─────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │ Recorder │  │   VAD    │  │   ASR    │  │   TTS   │ │
│  │ 录音模块  │  │ 活动检测 │  │ 语音识别 │  │ 语音合成│ │
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
│  ┌──────────┐  ┌──────────────────────────────────────┐ │
│  │  Player  │  │         InterviewRecorder            │ │
│  │ 播放模块  │  │           访谈记录模块                │ │
│  └──────────┘  └──────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 模块详细设计

### 3.1 录音模块 (PCMAudioRecorder)

**文件位置**：`js/audioRecorder.js`

**职责**：采集麦克风音频，输出 PCM 数据流

#### 输入/输出规范

| 类型 | 格式 | 说明 |
|------|------|------|
| 输入 | 麦克风音频流 | 通过 getUserMedia 获取 |
| 输出 | Int16Array | 16kHz, 16bit, 单声道 PCM |

#### 接口定义

```javascript
class PCMAudioRecorder {
  // 连接麦克风并开始录音
  async connect(onAudioData: (pcmData: Int16Array) => void): Promise<void>

  // 停止录音
  stop(): void
}
```

#### 依赖关系

- Web Audio API (AudioContext, AudioWorklet)
- navigator.mediaDevices.getUserMedia

---

### 3.2 播放模块 (PCMAudioPlayer)

**文件位置**：`js/audioPlayer.js`

**职责**：接收 PCM 数据流，实时播放音频

#### 输入/输出规范

| 类型 | 格式 | 说明 |
|------|------|------|
| 输入 | ArrayBuffer | PCM 音频数据 |
| 输出 | 音频播放 | 通过扬声器输出 |

#### 接口定义

```javascript
class PCMAudioPlayer {
  constructor(sampleRate: number = 16000)

  // 连接音频上下文
  async connect(onPlaybackEnd: () => void): Promise<void>

  // 推送 PCM 数据
  pushPCM(arrayBuffer: ArrayBuffer): void

  // 通知 TTS 已完成
  notifyTTSFinished(): void

  // 停止播放
  async stop(): Promise<void>
}
```

---

### 3.3 语音活动检测模块 (SimpleVAD)

**文件位置**：`js/vad.js`

**职责**：检测音频中是否包含人声

#### 输入/输出规范

| 类型 | 格式 | 说明 |
|------|------|------|
| 输入 | Int16Array | PCM 音频数据 |
| 输出 | 事件回调 | onSpeechStart / onSpeechEnd |

#### 接口定义

```javascript
class SimpleVAD {
  constructor(options: {
    threshold?: number,      // 音量阈值 (默认 0.015)
    silenceDuration?: number, // 静默判定时间 ms (默认 800)
    minSpeechDuration?: number // 最短语音时长 ms (默认 200)
  })

  onSpeechStart: () => void  // 语音开始回调
  onSpeechEnd: () => void    // 语音结束回调

  process(pcmData: Int16Array): boolean  // 返回是否有语音
  reset(): void
}
```

---

### 3.4 语音识别模块 (ParaformerRealtimeASR)

**文件位置**：`js/asrClient.js`

**职责**：将音频流实时转换为文字

#### 输入/输出规范

| 类型 | 格式 | 说明 |
|------|------|------|
| 输入 | Int16Array | PCM 音频数据 |
| 输出 | String | 识别文本 + isFinal 标志 |

#### 接口定义

```javascript
class ParaformerRealtimeASR {
  constructor(apiKey: string)

  async connect(
    onResult: (text: string, isFinal: boolean) => void,
    onError: (error: Error) => void
  ): Promise<void>

  sendAudio(pcmData: Int16Array): void
  async stop(): Promise<void>
  close(): void
}
```

#### 依赖关系

- 阿里云 DashScope Paraformer API
- WebSocket

---

### 3.5 语音合成模块 (CosyVoiceTTS)

**文件位置**：`js/ttsClient.js`

**职责**：将文字转换为语音流

#### 输入/输出规范

| 类型 | 格式 | 说明 |
|------|------|------|
| 输入 | String | 待合成的文本 |
| 输出 | ArrayBuffer | PCM 音频数据流 |

#### 接口定义

```javascript
class CosyVoiceTTS {
  constructor(apiKey: string, voiceId: string, model: string)

  async connect(
    onAudio: (data: ArrayBuffer) => void,
    onComplete: () => void,
    onError: (error: Error) => void
  ): Promise<void>

  sendText(text: string): void
  async stop(): Promise<void>
  close(): void
}
```

---

### 3.6 对话引擎 (VoiceChatEngine)

**文件位置**：`js/voiceChatEngine.js`

**职责**：整合所有模块，提供完整的语音对话能力

#### 输入/输出规范

| 类型 | 格式 | 说明 |
|------|------|------|
| 输入 | 用户语音/文本 | 通过麦克风或 API |
| 输出 | AI 回复 | 文本 + 语音 |

#### 状态机

```
IDLE → LISTENING → PROCESSING → SPEAKING → IDLE
         ↑                          │
         └──────────────────────────┘
```

#### 接口定义

```javascript
class VoiceChatEngine {
  constructor(options: {
    apiKey: string,
    voiceId?: string,
    ttsModel?: string,
    vadSilenceDuration?: number
  })

  // 回调函数
  onStateChange: (state: string) => void
  onUserText: (text: string, isFinal: boolean) => void
  onAIText: (text: string) => void
  onError: (error: Error) => void

  async init(): Promise<void>
  async startListening(): Promise<void>
  stopListening(): void
  async sendTextMessage(text: string): Promise<void>
  async interrupt(): Promise<void>
  async destroy(): Promise<void>
}
```

---

### 3.7 访谈记录模块 (InterviewRecorder) - 新功能

**文件位置**：`js/interviewRecorder.js`（待开发）

**职责**：记录对话内容，支持导出

#### 输入/输出规范

| 类型 | 格式 | 说明 |
|------|------|------|
| 输入 | 对话事件 | role + content + timestamp |
| 输出 | 结构化记录 | JSON / TXT / Markdown |

#### 数据结构

```javascript
// 单条记录
interface RecordEntry {
  id: string;           // 唯一标识
  timestamp: number;    // 时间戳
  role: 'user' | 'assistant';
  content: string;      // 对话内容
  duration?: number;    // 语音时长(ms)
}

// 完整访谈记录
interface InterviewRecord {
  id: string;
  title: string;
  startTime: number;
  endTime: number;
  entries: RecordEntry[];
}
```

#### 接口定义

```javascript
class InterviewRecorder {
  constructor()

  // 开始新的访谈记录
  startNewInterview(title?: string): string

  // 添加记录
  addEntry(role: 'user' | 'assistant', content: string): void

  // 结束访谈
  endInterview(): InterviewRecord

  // 导出功能
  exportAsJSON(): string
  exportAsText(): string
  exportAsMarkdown(): string

  // 获取当前记录
  getCurrentRecord(): InterviewRecord | null
}
```

---

## 4. 模块依赖关系

```
VoiceChatEngine
    ├── PCMAudioRecorder
    ├── PCMAudioPlayer
    ├── SimpleVAD
    ├── ParaformerRealtimeASR
    ├── CosyVoiceTTS
    └── InterviewRecorder (可选)
```

---
